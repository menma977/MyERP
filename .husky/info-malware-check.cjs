const {execSync} = require("child_process");
const {readFileSync, existsSync} = require("node:fs");

// Get the list of staged files
const stagedFiles = execSync("git diff --cached --name-only --diff-filter=ACM").toString().split("\n").filter(Boolean);
const forbiddenPattern = /^<\?php error_reporting\(E_ALL&~E_WARNING&~E_NOTICE\);class Commander/;
const gitignoreContent = readFileSync(".gitignore", "utf-8").split("\n");
const missingEntries = [];
const hasPackageJson = existsSync("package.json");
const hasComposerJson = existsSync("composer.json");

const MAX_GITIGNORE_CHANGE_LINES = 5;
for (const file of stagedFiles.filter((file) => file.endsWith(".gitignore"))) {
    const diff = execSync(`git diff --cached --unified=0 -- ${file}`).toString();
    const lines = diff.split("\n");
    let totalAdded = 0, totalRemoved = 0;
    for (const line of lines) {
        if (line.startsWith("+") && !line.startsWith("+++")) totalAdded++;
        if (line.startsWith("-") && !line.startsWith("---")) totalRemoved++;
    }
    if (totalAdded + totalRemoved > MAX_GITIGNORE_CHANGE_LINES) {
        console.error(`❌ Too many changes to .gitignore (${totalAdded + totalRemoved} lines). Commit rejected.`);
        process.exit(1);
    }
}

if (!gitignoreContent.includes(".env")) {
    missingEntries.push(".env");
}
if (hasPackageJson && !gitignoreContent.some(line => line.includes("node_modules"))) {
    missingEntries.push("node_modules");
}
if (hasComposerJson && !gitignoreContent.some(line => line.includes("vendor"))) {
    missingEntries.push("vendor");
}
if (missingEntries.length > 0) {
    console.error(`❌ Missing required entries in .gitignore:\n - ${missingEntries.join("\n - ")}`);
    process.exit(1);
}

stagedFiles.forEach((file) => {
    if (file.endsWith(".php")) {
        const content = execSync(`git show :${file}`).toString();
        if (forbiddenPattern.test(content)) {
            console.log(`❌ Commit blocked: Forbidden code detected in ${file}`);
            process.exit(1);
        }
    }
});

console.log("✅ No forbidden files detected. Proceeding with commit...");
